# Ingest data
* Download observations from SNEx and run ingesttar.py
* Download observations from archive.lco.global and run ingestzip.py

# Create apass and sloan catalogs for new objects
* run comparecatalogs.py to generate new catalogs
* Note if you are trying to reduce U band, you need to generate a local catalog. See XXX for details.

# Running the pipeline:
In general, the pipeline is called as a series of stages. Each stage should be called with the general format:
```
lscloop.py -e YYYYMMDD-YYYYMMDD -n NAME -s STAGE
```
Where:
* ```-e YYYYMMDD-YYYYMMDD``` is the date range of the observations you want to process
* ```-n NAME``` is the name of the object you want to process
* ```-s STAGE``` is the stage which is detailed below, in recommended order

## Broadly used options
* ```-F``` force a step to be run again, even if it succeeded last time
* ```-f FILTER``` run only on observations from one filter or set of filters (U,u,B,g,V,r,R,i,I,z,w,landolt, apass, sloan)
* ```--id``` run only on a specific image specified by a 3 digit number in the filename. For example you would use ```--id 046``` to run on the file elp1m008-fl05-20180302-0046-s91.
* ```-T``` run only on observations from one telescope. Valid options: 1m0, 2m0, or 0m4
* ```-I``` run only on observations from one instrument. Valid options: kb, fl, fs, sinistro, sbig

## Steps:
### Cosmic ray rejection:
* **Call**: ```-s cosmic```
* **Description**: Runs lacosmic to clean the images
* **Recommended Options**:
* **Other Options**: 

### WCS solution
* **Call**: ```-s wcs```
* **Description**: Generate a WCS solution for a given observation
* **Recommended Options**: 
    * ```--catalog=CATALOG```: where CATALOG is the apass or sloan catalog generated by comparecatalogs.py. This uses the location of the stars in the catalog to search for the location of stars in the image.
* **Other Options**: 
* **How to tell if this step worked**:
    * If the pipeline thinks it was successful, then the column wcs in the photlco table of the database will have a 0 in it, if it wasn't able to find a solution the value in this column will be 9999
    * To inspect images for which the pipeline failed:
        * open DS9
        * run the standard lscloop.py with the stage ```-s checkwcs -b wcs --show``` TODO: check if you need --show or -i
        * This displays image for which the wcs value is 9999 in DS9 with the catalog of stars on top of it. You should see the stars in the image at the locations marked by the catalog.
        * You will then be asked if this image is good with the option to answer: yes, no, or bad. Here if you answer bad, the quality will be set from 127 to 1, indicating that the image should not be used. If you mark no, then the wcs will be reset, indicating that you would like to try to calibrate the wcs again.
        * if you run this step without ```-b wcs``` then you can inspect all observations
* **How to fix this step if the image looks ok but the wcs failed**
    * rerun lscloop.py with the step ```-s wcs -b wcs``` to run only on those files for which the wcs failed
    * try running with a different catalog (e.g. if you tried apass, try again with sloan if available)
    * try running with no catalog
    * try using ```--use_sextractor``` flag TODO: describe this

### Generate a PSF model
* **Call**: ```-s psf```
* **Description**: creates a model psf for each image
* **Recommended Options**:
    * ```--catalog=CATALOG``` this uses the stars found at the location of stars in the catalog to generate a model PSF (TODO: check that this is true)
* **Other Options**: 
* **How to tell if this step worked**:
    * This step fills in the psf column with a filename (for the psf model) if it succeeds and an X if it fails.
    * To inspect images for which the pipeline failed:
        * open DS9
        * run the standard lscloop.py with the stage ```-s checkpsf -b psf --show``` TODO: check if you need --show or -i
        * This displays image for which the psf value is X in DS9 and in a separate window shows the psf model. The psf model should be a single source (e.g. not a blended gaussian). TODO: is it ok if its elongated?
        * You will then be asked if this image is good with the option to answer: yes, no, or bad. Here if you answer bad, the quality will be set from 127 to 1, indicating that the image should not be used. If you mark no, then the psf will be reset, indicating that you would like to try to calibrate the psf again.
        * if you run this step without ```-b psf``` then you can inspect all observations
        * BETA: ```-s checkpsf``` has the option to use matplotlib to display the psf rather than iraf with the option ```--no_iraf```. In this case, you can manipulate the figure (rotate and pan) to better see the psf
* **How to fix this step if the image looks ok but the psf step failed**
    * Try running without the  --catalog option
    * Try running with the ```--fwhm``` option. This is especially true for the 0.4m telescopes. Possible values to try: 5 and 7
    * 

### Generate instrumental magnitudes using psf photometry
* **Call**: ```-s psfmag```
* **Description**: Generate instrumental magnitudes using psf photometry
* **Recommended Options**:
* **Other Options**: 
* **How to tell if this step worked**:
    * This step sets the psfmag column to the instrumental magnitude if this step works and to 9999 if this step fails.
* **How to fix this step if the image looks ok but the psfmag step failed**

### Calculate the zeropoint
* **Call**: ```-s zcat```
* **Description**: Calculate the zeropoint of an image using the apparent magnitude of stars in the image as found in the catalog provided. This will be used to convert instrumental magnitudes to apparent magnitudes
* TODO: What does the pipeline default to when no catalog is provided?
* **Recommended Options**:
    * ```--catalog=CATALOG``` where CATALOG should be a catalog that corresponds to the filter you are trying to calibrate (e.g. apass, sloan, or landolt). The pipeline will use the location and apparent magnitude of the stars in this catalog to calculate the conversion between instrumental and apparent magnitude.
* **Other Options**: 
* **How to tell if this step worked**:
    * This set fills in the zcat column in the photlco database with a file name if it succeeded and an X if it failed
    * The most likely failure mode is that there are not enough stars between the catalog and the image. You can visually check this by:
        * Openning DS9
        * running ```-s zcat -i```
* **How to fix this step if the image looks ok but the zcat step failed**

### Generate instrumental magnitudes using psf photometry
* **Call**: ```-s mag```
* **Description**: Generate instrumental magnitudes using psf photometry
* **Recommended Options**:
    * ```--type fit```: this generates an apparent magnitude from the instrumental magnitude derived from psf photometry.
* **Other Options**: 
    * ```--type ph```: generate apparent magnitudes from aperture photometry
    * ```--type mag```: TODO: what does this mean?
* **How to tell if this step worked**:
    * If this step worked, an apparent magnitude will be put in the mag column of the photlco table. If this step failed this field will be set to 9999
* **How to fix this step if the image looks ok but the psfmag step failed**

### Evaluating Image quality from lightcurve outliers:
* **Call**: ```-s getmag``` TODO: check if you need --show or -i
* **Description**: view whole light curve and inspect cutouts of object and residuals after the psf subtraction. 
* **Recommended Options**:
* **Other Options**:
    * ```-f FILTER``` where FILTER is U,B,g,V,r,R,i,I, landolt, apass, or sloan. This displays light curve for only this filter or set of filters
    * If a point looks funny, then you can click on it. This brings up an image with a cutout of the image, and a cut out of the residual after the psf has been subtracted. It will ask you if you want to make this image with yes, no, or bad (TODO: verify this and fill in what happens if you answer no vs bad)


#
* Check whether there are enough stars in common between a field and the catalog being used in the zcat step ```-s zcat -i```

### Eliminate bad images
* **Call**: ```-s checkquality --show``` TODO: check if you need --show or -i
* **Description**: if an image has been marked as bad, then the quality flag is set from 127 to 1. When you run the checkquality step it displays these images and gives you the option to mark them as good. Note: you need to open DS9 before running this stage 
* **Other Options**:  
TODO: Figure out where checkquality should go in this workflow

# Creating an Landolt Catalog:
## Download landolt standard star catalogs
* These need to be obtained from LCO (Jamie gave me a zip file with them)
* Put these files in the directory $LCOSNPIPE/trunk/src/lsc/standard/cat/landolt
* Reinstall the pipeline ```python setup.py install```

## Download the Standard Star Observations
* Find standard stars that were observed during the epoch you need in the filter you need (U) and at least 1 other filter (for color correction) - recommended B and V
* Search archive.lco.global for obstype=STANDARD, set date range, filter, if applicable telescope and site (e.g. fo 2018zd I set site=elp and telescope=fl05)
* Download the reduced observations
* run python ingestzip.py -f downloaded_directory_or_zip_filename
* Calibrate you standard star observations (below is an example for L94 where the catalog I point to is the one I got from LCO as described above and I'm calibrating for U band observations of 2018zd)
```
lscloop.py -e 20180301-20180310 -n L94 --stage cosmic
lscloop.py -e 20180301-20180310 -n L94 --stage wcs
lscloop.py -e 20180301-20180310 -n L94 --stage psf 
lscloop.py -e 20180301-20180310 -n L94 --stage psfmag
lscloop.py -e 20180301-20180310 -n L94 --stage zcat 
lscloop.py -e 20180301-20180310 -n L94 --stage mag --type fit
```

# Create a catalog of standard stars for Landolt filters
* This calculated the apparent magnitude for the stars in a given filter. If a single class of telescopes seems to be an outlier, then you should limit the telescopes used to calculate the apparent magnitude to a single class of telescopes with the ```-T 1m0``` flag
```
lscloop.py -n 'SN 2018zd' -e 20180302-20200301 -f landolt -s local -i --catalog=/Users/bostroem/anaconda/envs/lcogtsnpipe/lib/python2.7/site-packages/lsc/standard/cat/apass/SN2018zd_apass.cat
```
* Can also point to sloan catalog if needed
* ```-s``` local does not calculate zero points. It calculates the apparent magnitudes of the stars. So I guess in theory you should not have to restrict yourself to a single telescope class. But based on your plot, the 2m0 observations seem to be outliers, so I would still exclude them. ```-s zcat``` is when you actually calculate the zero points, and that runs on one image at a time. ```-s mag``` uses cross-image information to calculate the SN magnitude, but that handles the different telescope classes correctly.

* Check plots for:
    - if there is a big difference between the BV filters of Landolt and APASS for a large number of stars (a few stars will be variable)
    - I guess the main thing is that some of the standard field observations will be bad because of clouds or whatever, so make sure they are not pulling the median zero point away too much


## Move the catalog to the catalog directory:
```
mv sn2018zd_landolt_20200408_14_04.cat /supernova/conda-envs/pipeline/lib/python2.7/site-packages/lsc/standard/cat/landolt/
```